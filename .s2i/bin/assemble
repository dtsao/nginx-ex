#!/bin/bash
# from https://docs.openshift.com/container-platform/3.6/using_images/s2i_images/customizing_s2i_images.html
# normal assemble script is from https://github.com/sclorg/nginx-container/blob/master/1.12/s2i/bin/assemble
echo "--> Before assembling"

echo "edit nginx.conf to disable ipv6"
sed -i.bak '/\[::]:8080/d' ./nginx.conf 

/usr/libexec/s2i/assemble
rc=$?

if [ $rc -eq 0 ]; then
    echo "After successful assembling"
    
    #echo "edit nginx.conf to disable ipv6"
    # causes error: sed: couldn't open temporary file /etc/opt/rh/rh-nginx112/nginx/sedyq39XF: Permission denied
    #sed -i.bak '/\[::]:8080/d' ${NGINX_CONF_PATH} 
else
    echo "After failed assembling"
fi

exit $rc
